"0","#| label: Station Analysis"
"0","#| message: false"
"0","#| warning: false"
"0",""
"0","# What this chunk does:"
"0","#  1) Pulls ACS race (B03002) to compute minority share per tract"
"0","#  2) Builds 2-mile service areas around Fire/EMS stations (EPSG:3365, ftUS)"
"0","#  3) Area-weights tract populations to estimate % population covered vs. uncovered"
"0","#  4) Aggregates key metrics to counties"
"0","#  5) Outputs:"
"0","#     - Statewide table (incl. ""% Uncovered that is Minority"")"
"0","#     - Equity Table A (Top 10 counties by estimated minority uncovered)"
"0","#     - Tract-level Coverage vs. Density Map (deficit index)"
"0","#     - Tract-level Coverage Equity Map (high-minority + low-coverage)"
"0","#"
"0","# Notes:"
"0","#  - Distance proxy: 2 miles â‰ˆ ~5-min drive (network service areas would be ideal)"
"0","#  - Population coverage is area-weighted at the tract level"
"0","#  - EPSG:3365 (PA South, ftUS) is used for accurate buffering/distances"
"0",""
"0",""
"0","# Pull total population and non-Hispanic White counts at the tract level"
"0","race_vars <- c(total = ""B03002_001"", white_nonhisp = ""B03002_003"")"
"0",""
"0","pa_race <- get_acs("
"0","  geography = ""tract"","
"0","  variables = race_vars,"
"0","  state     = ""PA"","
"0","  year      = 2022,"
"0","  survey    = ""acs5"","
"0","  output    = ""wide"""
"0",") %>%"
"0","  transmute("
"0","    GEOID,"
"0","    total         = totalE,"
"0","    white_nonhisp = white_nonhispE"
"0","  ) %>%"
"0","  mutate("
"0","    # Count of residents who are NOT non-Hispanic White"
"0","    minority     = pmax(total - white_nonhisp, 0),"
"0","    pct_minority = if_else(total > 0, minority / total * 100, NA_real_)"
"0","  )"
"0",""
"0","# Project counties and tracts to EPSG:3365 and attach race"
"0","pa_proj <- st_transform(pa_counties, 3365)"
"0","tracts_proj <- st_transform(PA_tracts, 3365) %>%"
"0","  left_join(pa_race, by = ""GEOID"")"
"0",""
"0",""
"0","# Build 2-mile (= 10,560 ft) coverage"
"0","two_miles_ft <- 10560"
"0",""
"0","# Buffer Fire/EMS stations and dissolve into one coverage polygon"
"0","stns_buffer    <- st_buffer(stations_proj, dist = two_miles_ft)"
"0","coverage_union <- st_union(stns_buffer) |> st_as_sf()"
"0",""
"0","# Clip to Pennsylvania extent for clean intersections/plots"
"0","coverage_union <- st_intersection(coverage_union, st_union(pa_proj) |> st_as_sf())"
"0",""
"0","# Compute tract areas in square miles (for density + apportionment)"
"0","tracts_proj$area_mi2 <- as.numeric(set_units(st_area(tracts_proj), ""mi^2""))"
"0",""
"0","# Intersect coverage with tracts to get covered sub-areas"
"0","t_cov_parts <- st_intersection(tracts_proj, coverage_union)"
"0",""
"0","# Sum covered area per tract (sq mi)"
"0","t_cov_area <- t_cov_parts %>%"
"0","  mutate(area_cov_mi2 = as.numeric(set_units(st_area(geometry), ""mi^2""))) %>%"
"0","  st_drop_geometry() %>%"
"0","  group_by(GEOID) %>%"
"0","  summarise(area_cov_mi2 = sum(area_cov_mi2, na.rm = TRUE), .groups = ""drop"")"
"0",""
"0","# Combine: density, coverage fraction, covered/uncovered population"
"0","tracts_cov <- tracts_proj %>%"
"0","  left_join(t_cov_area, by = ""GEOID"") %>%"
"0","  mutate("
"0","    area_cov_mi2  = replace_na(area_cov_mi2, 0),"
"0","    pop           = total_popE,                                # from your earlier ACS pull"
"0","    pop_density   = if_else(area_mi2 > 0, pop / area_mi2, NA_real_),"
"0","    cover_frac    = pmin(1, if_else(area_mi2 > 0, area_cov_mi2 / area_mi2, 0)),"
"0","    pop_cov       = pop * cover_frac,"
"0","    pop_uncovered = pmax(0, pop - pop_cov)"
"0","  ) %>%"
"0","  # Recompute minority fields on THIS object to guarantee availability downstream"
"0","  mutate("
"0","    minority     = if_else(!is.na(total) & !is.na(white_nonhisp),"
"0","                           pmax(total - white_nonhisp, 0), NA_real_),"
"0","    pct_minority = if_else(!is.na(total) & total > 0,"
"0","                           minority / total * 100, NA_real_)"
"0","  )"
"0",""
"0",""
"0","# Estimate minority share within the uncovered population at the tract level"
"0","tracts_equity <- tracts_cov %>%"
"0","  mutate("
"0","    minority_share_tr   = if_else(!is.na(total) & total > 0, minority / total, NA_real_),"
"0","    est_uncovered_minor = pop_uncovered * minority_share_tr"
"0","  )"
"0",""
"0","# Compute the statewide row (raw)"
"0","statewide_tbl_raw <- tracts_equity %>%"
"0","  st_drop_geometry() %>%"
"0","  summarise("
"0","    Total_Population             = sum(pop, na.rm = TRUE),"
"0","    Covered_Population           = sum(pop_cov, na.rm = TRUE),"
"0","    Uncovered_Population         = sum(pop_uncovered, na.rm = TRUE),"
"0","    Estimated_Uncovered_Minority = sum(est_uncovered_minor, na.rm = TRUE),"
"0","    Stations                     = nrow(stations_proj)"
"0","  ) %>%"
"0","  mutate("
"0","    Pct_Covered                    = Covered_Population   / Total_Population,"
"0","    Pct_Uncovered                  = Uncovered_Population / Total_Population,"
"0","    Pct_Uncovered_That_Is_Minority = if_else("
"0","      Uncovered_Population > 0,"
"0","      Estimated_Uncovered_Minority / Uncovered_Population,"
"0","      NA_real_"
"0","    )"
"0","  )"
"0",""
"0","# Make a display-friendly, formatted one-row table"
"0","statewide_tbl_display <- statewide_tbl_raw %>%"
"0","  transmute("
"0","    `Total population`                     = scales::comma(Total_Population),"
"0","    `Covered population`                   = scales::comma(Covered_Population),"
"0","    `Uncovered population`                 = scales::comma(Uncovered_Population),"
"0","    `Estimated uncovered minority`         = scales::comma(Estimated_Uncovered_Minority),"
"0","    `Stations (count)`                     = scales::comma(Stations),"
"0","    `Percent covered`                      = scales::percent(Pct_Covered, accuracy = 0.01),"
"0","    `Percent uncovered`                    = scales::percent(Pct_Uncovered, accuracy = 0.01),"
"0","    `Uncovered that is minority`           = scales::percent(Pct_Uncovered_That_Is_Minority, accuracy = 0.01)"
"0","  )"
"0",""
"0","knitr::kable("
"0","  statewide_tbl_display,"
"0","  caption = ""Statewide coverage & equity (area-weighted, 2-mile buffers)"","
"0","  align   = ""c"","
"0","  booktabs = TRUE"
"0",")"
